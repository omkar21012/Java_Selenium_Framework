name: Nightly Selenium Grid Run

on:
  schedule:
    - cron: '30 20 * * *'  # üïë Runs every night at 2:00 AM IST (20:30 UTC)
  workflow_dispatch:        # ‚ñ∂ Manual trigger option

jobs:
  selenium-tests:
    runs-on: ubuntu-latest   # Use Linux for Docker support

    steps:
      # 1Ô∏è‚É£ Checkout source code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up JDK (change version if needed)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      # 3Ô∏è‚É£ Start Selenium Grid using Docker
      - name: Start Selenium Grid
        run: |
          docker network create selenium-grid || true

          echo "üöÄ Starting Selenium Hub..."
          docker run -d --name selenium-hub --network selenium-grid -p 4442-4444:4442-4444 selenium/hub:latest

          echo "üöÄ Starting Chrome Nodes..."
          docker run -d --name chrome1 --network selenium-grid -e SE_EVENT_BUS_HOST=selenium-hub \
            -e SE_EVENT_BUS_PUBLISH_PORT=4442 -e SE_EVENT_BUS_SUBSCRIBE_PORT=4443 \
            -e SE_NODE_OVERRIDE_HEADLESS=false -p 7900:7900 selenium/node-chrome:latest

          docker run -d --name chrome2 --network selenium-grid -e SE_EVENT_BUS_HOST=selenium-hub \
            -e SE_EVENT_BUS_PUBLISH_PORT=4442 -e SE_EVENT_BUS_SUBSCRIBE_PORT=4443 \
            -e SE_NODE_OVERRIDE_HEADLESS=false -p 7901:7900 selenium/node-chrome:latest

          echo "üïê Waiting for Selenium Grid to be ready..."
          sleep 20

          curl http://localhost:4444/status || true

      # 4Ô∏è‚É£ Verify Maven setup
      - name: Verify Maven
        run: mvn -v

      # 5Ô∏è‚É£ Run Selenium TestNG suite on the Grid
      - name: Run Selenium Tests on Grid
        run: |
          mvn clean test -Dmaven.test.failure.ignore=true \
            -DrunMode=grid \
            -Dbrowser=chrome \
            -Dheadless=false \
            -Dsurefire.suiteXmlFiles=testng.xml

      # 6Ô∏è‚É£ List test-output (for debugging)
      - name: List test-output folder
        if: always()
        run: ls -R test-output || true

      # 7Ô∏è‚É£ Upload Extent/TestNG Reports
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Selenium-Test-Reports
          path: test-output/

      # 8Ô∏è‚É£ Stop & remove Docker containers (cleanup)
      - name: Stop and clean up Docker
        if: always()
        run: |
          echo "üßπ Cleaning up containers..."
          docker rm -f chrome1 chrome2 selenium-hub || true
          docker network rm selenium-grid || true
